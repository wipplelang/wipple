version: "3"

tasks:
    run:
        run: once
        cmds:
            - cargo run --bin wipple -- run {{.CLI_ARGS}}

    compile:
        run: once
        cmds:
            - cargo run --bin wipple -- compile {{.CLI_ARGS}}

    test:
        run: once
        cmds:
            - cargo run --bin wipple-test --release -- tests/*.wpl {{.CLI_ARGS}}

    test-file:
        run: once
        cmds:
            - cargo run --bin wipple-test -- {{.CLI_ARGS}}

    flamegraph:
        run: once
        cmds:
            - cargo flamegraph --root --dev --flamechart --bin wipple -- run {{.CLI_ARGS}}

    cli:
        run: once
        cmds:
            - cargo install --force --path tools/cli
        env:
            CARGO_TARGET_DIR: target

    serve:
        run: once
        cmds:
            - task: website
            - npx http-server -c-1 website/_site --cors

    website:
        run: once
        deps:
            - cli
            - website-shared
            - website-home
            - website-compiler-docs
            - website-embed
            - website-playground
            - website-std
            - website-doc

    website-shared:
        run: once
        deps:
            - cli
        dir: website/shared
        cmds:
            - (cd .. && npm i)
            - npm run build

    website-home:
        run: once
        deps:
            - website-shared
        dir: website/home
        cmds:
            - npm i
            - npm run build
            - mkdir -p ../_site
            - cp -r ./_site/* ../_site

    website-compiler-docs:
        run: once
        deps:
            - website-home
        dir: website/compiler-docs
        cmds:
            - mdbook build
            - mkdir -p ../_site/compiler-docs
            - cp -r book/* ../_site/compiler-docs

    website-playground:
        run: once
        deps:
            - website-playground-all
        dir: website/playground
        cmds:
            - mkdir -p ../_site/playground
            - cp -r dist/* ../_site/playground

    website-playground-public-dev:
        dir: website/playground
        cmds:
            - task: website-playground-public
            - mkdir -p ../_site/playground
            - cp -r dist/* ../_site/playground
        sources:
            - public/**/*

    website-playground-all:
        deps:
            - website-playground-app
            - website-playground-public
            - task: website-playground-ui
              vars: { NAME: energy }
            - task: website-playground-ui
              vars: { NAME: game }
            - task: website-playground-ui
              vars: { NAME: graphing }
            - task: website-playground-ui
              vars: { NAME: music }
            - task: website-playground-ui
              vars: { NAME: turtle }

    website-playground-app:
        run: once
        deps:
            - website-home
            - website-shared
        dir: website/playground
        cmds:
            - npm i
            - npm run build

    website-playground-public:
        dir: website/playground
        cmds:
            - mkdir -p dist
            - cp -r public/* dist

    website-playground-ui:
        label: 'website-playground-ui-{{.NAME}}'
        deps:
            - website-playground-app
        dir: website/playground/ui/{{.NAME}}
        cmds:
            - mkdir -p ../../dist/doc
            - mkdir -p ../../dist/ui/{{.NAME}}
            - npm i
            - npm run build
            - cp dist/* ../../dist/ui/{{.NAME}}

    website-embed:
        run: once
        deps:
            - website-home
            - website-shared
            - website-playground
        dir: website/embed
        cmds:
            - npm run build
            - mkdir -p ../_site/embed
            - cp -r dist/* ../_site/embed

    website-std:
        run: once
        deps:
            - website-home
        dir: website
        cmds:
            - mkdir -p _site/std
            - cp -r ../std/* _site/std

    website-doc:
        run: once
        deps:
            - website-playground
        dir: website
        cmds:
            - mkdir -p _site/doc
            - >
                wipple doc ../std/std.wpl
                --title 'Wipple Standard Library'
                --image 'https://wipple.dev/images/logo.svg'
                --link 'https://wipple.dev'
                --include-builtins
                --std ../std/std.wpl
                > _site/doc/std.html
            - mv _site/playground/doc/*.html _site/doc
